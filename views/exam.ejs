<!DOCTYPE html>
<html lang="vi" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Câu hỏi <%= qNum %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  
  <form class="exam-form" id="exam-form" action="/submit-answer" method="POST">
    <header class="navbar navbar-expand-lg bg-body-tertiary sticky-top border-bottom">
      <div class="container-fluid">
        <h2 class="h5 mb-0">Bài thi trắc nghiệm</h2>
        <div id="timer" class="h4 mb-0 text-danger fw-bold">180:00</div>
      </div>
    </header>
    
    <main class="container-fluid mt-4">
      <div class="row g-4">
        
        <div class="col-12 col-lg-10 order-lg-1">
          <div class="card bg-body-secondary">
            <div class="card-body">
              <h3 class="h5 card-title">Câu <%= qNum %>:</h3>
              
              <% if (question.questionText) { %>
                <p class="card-text"><%= question.questionText %></p>
              <% } %>
              
              <% if (question.questionImage) { %>
                <img src="/<%= question.questionImage %>" alt="Hình ảnh câu hỏi" class="img-fluid rounded mb-3">
              <% } %>
              
              <hr>
              
              <div class="options-container list-group"> <% const savedAnswers = userAnswers[qNum] || []; %>
                <% question.options.forEach((opt, index) => { %>
                  <% const optionValue = (index + 1).toString(); %>
                  <% const isChecked = savedAnswers.includes(optionValue); %>
                  
                  <label class="list-group-item d-flex gap-3">
                    <input 
                      class="form-check-input flex-shrink-0"
                      type="<%= question.isMultipleChoice ? 'checkbox' : 'radio' %>" 
                      name="answer" 
                      value="<%= optionValue %>"
                      <%= isChecked ? 'checked' : '' %>>
                    
                    <span class="pt-0">
                      <% if (opt.text) { %>
                        <span><%= opt.text %></span>
                      <% } %>
                      
                      <% if (opt.image) { %>
                        <img src="/<%= opt.image %>" alt="Hình ảnh lựa chọn" class="img-fluid rounded mt-2">
                      <% } %>
                    </span>
                  </label>
                <% }); %>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-12 col-lg-2 order-3 order-lg-2">
          <div class="card bg-body-secondary sticky-top" style="top: 70px;">
            <div class="card-header">
              <h4 class="h6 mb-0">Tổng quan (Nhảy câu)</h4>
            </div>
            <div class="card-body">
              <%- include('partials/overview', { totalQuestions: totalQuestions, userAnswers: userAnswers, results: null, currentQNum: qNum }) %>
            </div>
          </div>
        </div>
      </div>
    </main>
    
    <footer class="navbar fixed-bottom bg-body-tertiary border-top">
      <div class="container-fluid d-flex justify-content-between p-2">
        <% if (qNum > 1) { %>
          <button type="submit" name="action" value="back" class="btn btn-secondary w-25">Quay lại</button>
        <% } else { %>
          <button class="btn btn-secondary w-25" disabled>Quay lại</button>
        <% } %>
        
        <button type="submit" name="action" value="finish" class="btn btn-danger w-25" onclick="return confirm('Bạn có chắc muốn nộp bài?')">Nộp bài</button>
        
        <% if (qNum < totalQuestions) { %>
          <button type="submit" name="action" value="next" class="btn btn-primary w-25">Tiếp theo</button>
        <% } else { %>
          <button class="btn btn-primary w-25" disabled>Tiếp theo</button>
        <% } %>
      </div>
    </footer>
    
    <input type="hidden" name="qNum" value="<%= qNum %>">
  </form>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const startTime = <%= startTime %>;
    const timeLimitInSeconds = <%= timeLimit %>;
  </script>
  <script src="/js/timer.js"></script>
</body>
</html>