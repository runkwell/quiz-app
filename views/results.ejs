<!DOCTYPE html>
<html lang="vi" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kết quả thi</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <header class="navbar navbar-expand-lg bg-body-tertiary border-bottom sticky-top">
    <div class="container-fluid">
      <h2 class="h5 mb-0">Kết quả bài thi</h2>
      <div class="h4 mb-0 text-success">
        <%= totalScore %>% (<%= score %> / <%= totalQuestions %>)
      </div>
    </div>
  </header>
  
  <main class="container-fluid mt-4">
    <div class="row g-4">
      <div class="col-12 col-lg-10 order-lg-1">
        <div class="mb-3">
          <a href="/" class="btn btn-primary">Làm bài mới</a>
          <a href="/history" class="btn btn-secondary">Xem lịch sử</a>
        </div>
        
        <% results.forEach(r => { %>
          <div class="card mb-4 border-light bg-body-secondary <%= r.isCorrect ? 'border-success' : 'border-danger' %>" id="q-<%= r.qNum %>">
            <div class="card-header <%= r.isCorrect ? 'text-success' : 'text-danger' %>">
              <h4 class="h6 mb-0">
                Câu <%= r.qNum %>: <%= r.isCorrect ? '(Đúng)' : '(Sai)' %>
                <span class="badge bg-secondary ms-2">Mapping câu <%= r.poolQNum %> trong Pool</span>
              </h4>
            </div>
            <div class="card-body">
              <% if (r.question.questionText) { %><p class="fw-bolder"><%= r.question.questionText %></p><% } %>
              <% if (r.question.questionImage) { %><img src="/<%= r.question.questionImage %>" alt="Hình ảnh câu hỏi" class="img-fluid rounded mb-3"><% } %>
              
              <div class="options-container list-group">
                <% r.question.options.forEach((opt, index) => { %>
                  <% const optionValue = (index + 1).toString(); %>
                  <% const isUserSelected = r.userAns.includes(optionValue); %>
                  <% const isCorrectOption = r.correctOptions.includes(optionValue); %>
                  
                  <% 
                    let optClass = "list-group-item";
                    if (isCorrectOption) {
                      optClass += " list-group-item-success"; 
                    }
                    if (isUserSelected && !isCorrectOption) {
                      optClass += " list-group-item-danger"; 
                    }
                  %>
                  
                  <div class="<%= optClass %> d-flex gap-3">
                    <input 
                      class="form-check-input flex-shrink-0"
                      type="<%= r.question.isMultipleChoice ? 'checkbox' : 'radio' %>" 
                      disabled
                      <%= isUserSelected ? 'checked' : '' %>>
                    
                    <span class="pt-0">
                      <% if (opt.text) { %><span><%= opt.text %></span><% } %>
                      <% if (opt.image) { %><img src="/<%= opt.image %>" alt="Hình ảnh lựa chọn" class="img-fluid rounded mt-2"><% } %>
                    </span>
                  </div>
                <% }); %>
              </div>
              
              <% const explanationText = explanations[r.poolQNum]; %>
              <% if (explanationText) { %>
                <%
                  // Logic tìm kiếm và thay thế để in màu chữ "correct" và "wrong"
                  let coloredExplanation = explanationText
                    // 1. Tô màu correct/wrong
                    .replace(/\b(correct|wrong)\b/gi, (match) => 
                        `<span class="${match.toLowerCase()}">${match}</span>`
                    )
                    // 2. Xóa ** và chuyển text thành màu xanh da trời (sky blue) cho từ example
                    .replace(/\*\*(.*?)\*\*/g, (match, p1) => {
                        return `<span class="example-text">${p1.trim()}</span>`;
                    });


                    //.replace(/correct/g, '<span class="correct">correct</span>')
                    //.replace(/wrong/g, '<span class="wrong">wrong</span>')
                    //.replace(/Correct/g, '<span class="correct">Correct</span>')
                    //.replace(/Wrong/g, '<span class="wrong">Wrong</span>');
                %>
                <div class="explanation-container">
                  <h6 class="text-primary">Giải thích chi tiết:</h6>
                  <pre class="mb-0  explain-text"><%- coloredExplanation %></pre> 
                </div>
              <% } %>
              </div>
          </div>
        <% }); %>
      </div>
      
      <div class="col-12 col-lg-2 order-3 order-lg-2">
        <div class="card bg-body-secondary sticky-top" style="top: 70px;">
           <div class="card-header">
            <h4 class="h6 mb-0">Tổng quan kết quả</h4>
           </div>
           <div class="card-body">
            <%- include('partials/overview', { totalQuestions: totalQuestions, userAnswers: userAnswers, results: results, currentQNum: null }) %>
           </div>
        </div>
      </div>
    </div>
  </main>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>